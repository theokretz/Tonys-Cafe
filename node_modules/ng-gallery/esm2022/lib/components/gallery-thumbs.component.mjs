import { Component, Input, Output, ViewChild, ViewChildren, QueryList, ElementRef, EventEmitter, ChangeDetectionStrategy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Subject, debounceTime, takeUntil, tap } from 'rxjs';
import { ThumbnailsPosition, ThumbnailsView } from '../models/constants';
import { HorizontalThumbAdapter, VerticalThumbAdapter } from './adapters';
import { resizeObservable } from '../utils/resize-observer';
import { GalleryThumbComponent } from './gallery-thumb.component';
import * as i0 from "@angular/core";
import * as i1 from "../smooth-scroll";
import * as i2 from "@angular/cdk/platform";
import * as i3 from "@angular/common";
class GalleryThumbsComponent {
    get slider() {
        return this.sliderEl.nativeElement;
    }
    constructor(_el, _zone, _smoothScroll, _cd, _platform) {
        this._el = _el;
        this._zone = _zone;
        this._smoothScroll = _smoothScroll;
        this._cd = _cd;
        this._platform = _platform;
        /** Thumbnails view enum */
        this.thumbnailsView = ThumbnailsView;
        this._destroyed$ = new Subject();
        /** Stream that emits when thumb is clicked */
        this.thumbClick = new EventEmitter();
        /** Stream that emits when an error occurs */
        this.error = new EventEmitter();
        this.items = new QueryList();
    }
    ngOnChanges(changes) {
        if (changes.config) {
            // Sets sliding direction
            if (changes.config.currentValue?.thumbPosition !== changes.config.previousValue?.thumbPosition) {
                switch (this.config.thumbPosition) {
                    case ThumbnailsPosition.Right:
                    case ThumbnailsPosition.Left:
                        this.adapter = new VerticalThumbAdapter(this.slider, this.config);
                        break;
                    case ThumbnailsPosition.Top:
                    case ThumbnailsPosition.Bottom:
                        this.adapter = new HorizontalThumbAdapter(this.slider, this.config);
                        break;
                }
                if (this._platform.isBrowser) {
                    if (!changes.config.firstChange) {
                        // Keep the correct sliding position when direction changes
                        requestAnimationFrame(() => {
                            this.scrollToIndex(this.state.currIndex, 'auto');
                        });
                    }
                    // Reactivate gestures
                    this.enableDisableGestures();
                }
            }
            if (this._platform.isBrowser) {
                if (!changes.config.firstChange && changes.config.currentValue?.thumbMouseSlidingDisabled !== changes.config.previousValue?.thumbMouseSlidingDisabled) {
                    this.enableDisableGestures();
                }
                this.slider.style.setProperty('--thumb-height', `${this.config.thumbHeight}px`);
                this.slider.style.setProperty('--thumb-width', `${this.config.thumbWidth}px`);
            }
        }
        if (this._platform.isBrowser && changes.state && (changes.state.firstChange || !this.config.thumbDetached)) {
            if (changes.state.currentValue?.currIndex !== changes.state.previousValue?.currIndex) {
                // Scroll slide to item when current index changes.
                requestAnimationFrame(() => {
                    this.scrollToIndex(this.state.currIndex, changes.state?.firstChange ? 'auto' : 'smooth');
                });
            }
        }
    }
    ngAfterViewInit() {
        if (this._platform.isBrowser) {
            // Workaround: opening a lightbox (centralised) with last index active, show in wrong position
            setTimeout(() => this.scrollToIndex(this.state.currIndex, 'auto'), 200);
            this._zone.runOutsideAngular(() => {
                // Update necessary calculation on host resize
                resizeObservable(this._el.nativeElement).pipe(debounceTime(this.config.resizeDebounceTime), tap(() => {
                    // Update thumb centralize size
                    const el = this.items.get(this.state.currIndex)?.nativeElement;
                    if (el) {
                        this.slider.style.setProperty('--thumb-centralize-start-size', this.adapter.getCentralizerStartSize() + 'px');
                        this.slider.style.setProperty('--thumb-centralize-end-size', this.adapter.getCentralizerEndSize() + 'px');
                    }
                    this._cd.detectChanges();
                    this.scrollToIndex(this.state.currIndex, 'auto');
                }), takeUntil(this._destroyed$)).subscribe();
            });
        }
    }
    ngAfterViewChecked() {
        const el = this.items.get(this.state.currIndex)?.nativeElement;
        if (el && this._platform.isBrowser) {
            this.slider.style.setProperty('--thumb-centralize-start-size', this.adapter.getCentralizerStartSize() + 'px');
            this.slider.style.setProperty('--thumb-centralize-end-size', this.adapter.getCentralizerEndSize() + 'px');
        }
    }
    ngOnDestroy() {
        this.deactivateGestures();
        this._destroyed$.next();
        this._destroyed$.complete();
    }
    trackByFn(index, item) {
        return item.type;
    }
    scrollToIndex(value, behavior) {
        this._zone.runOutsideAngular(() => {
            this.slider.style.scrollSnapType = 'unset';
            const el = this.items.get(value)?.nativeElement;
            if (el) {
                this._smoothScroll.scrollTo(this.slider, this.adapter.getScrollToValue(el, behavior)).then(() => {
                    this.slider.style.scrollSnapType = this.adapter.scrollSnapType;
                });
            }
        });
    }
    enableDisableGestures() {
        if (!this._platform.IOS && !this._platform.ANDROID) {
            // Enable/Disable mouse sliding on desktop browser only
            if (!this.config.thumbMouseSlidingDisabled) {
                this.activateGestures();
            }
            else {
                this.deactivateGestures();
            }
        }
    }
    activateGestures() {
        if (typeof Hammer !== 'undefined' && !this.config.disableThumb) {
            const direction = this.adapter.panDirection;
            // Activate gestures
            this._zone.runOutsideAngular(() => {
                this._hammer = new Hammer(this._el.nativeElement, { inputClass: Hammer.MouseInput });
                this._hammer.get('pan').set({ direction });
                let panOffset = 0;
                this._hammer.on('panstart', () => {
                    panOffset = this.adapter.scrollValue;
                    // Disable scroll-snap-type functionality
                    this.slider.style.scrollSnapType = 'unset';
                    this.slider.classList.add('g-sliding');
                });
                this._hammer.on('panmove', (e) => this.slider.scrollTo(this.adapter.getPanValue(panOffset, e, 'auto')));
                this._hammer.on('panend', () => {
                    // Enable scroll-snap-type functionality
                    this.slider.style.scrollSnapType = this.adapter.scrollSnapType;
                    this.slider.classList.remove('g-sliding');
                });
            });
        }
    }
    deactivateGestures() {
        this._hammer?.destroy();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.1", ngImport: i0, type: GalleryThumbsComponent, deps: [{ token: i0.ElementRef }, { token: i0.NgZone }, { token: i1.SmoothScrollManager }, { token: i0.ChangeDetectorRef }, { token: i2.Platform }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.1.1", type: GalleryThumbsComponent, isStandalone: true, selector: "gallery-thumbs", inputs: { state: "state", config: "config" }, outputs: { thumbClick: "thumbClick", error: "error" }, viewQueries: [{ propertyName: "sliderEl", first: true, predicate: ["slider"], descendants: true, static: true }, { propertyName: "items", predicate: GalleryThumbComponent, descendants: true, read: ElementRef }], usesOnChanges: true, ngImport: i0, template: `
    <div #slider
         class="g-slider"
         [attr.centralised]="config.thumbView === thumbnailsView.Contain || adapter.isContentLessThanContainer">
      <div class="g-slider-content">
        <gallery-thumb *ngFor="let item of state.items; trackBy: trackByFn; index as i"
                       [type]="item.type"
                       [config]="config"
                       [data]="item.data"
                       [currIndex]="state.currIndex"
                       [index]="i"
                       [count]="state.items.length"
                       (click)="config.disableThumb ? null : thumbClick.emit(i)"
                       (error)="error.emit({ itemIndex: i, error: $event })">
        </gallery-thumb>
      </div>
    </div>
  `, isInline: true, dependencies: [{ kind: "ngmodule", type: CommonModule }, { kind: "directive", type: i3.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "component", type: GalleryThumbComponent, selector: "gallery-thumb", inputs: ["config", "index", "count", "currIndex", "type", "data"], outputs: ["error"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
export { GalleryThumbsComponent };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.1", ngImport: i0, type: GalleryThumbsComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'gallery-thumbs',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    template: `
    <div #slider
         class="g-slider"
         [attr.centralised]="config.thumbView === thumbnailsView.Contain || adapter.isContentLessThanContainer">
      <div class="g-slider-content">
        <gallery-thumb *ngFor="let item of state.items; trackBy: trackByFn; index as i"
                       [type]="item.type"
                       [config]="config"
                       [data]="item.data"
                       [currIndex]="state.currIndex"
                       [index]="i"
                       [count]="state.items.length"
                       (click)="config.disableThumb ? null : thumbClick.emit(i)"
                       (error)="error.emit({ itemIndex: i, error: $event })">
        </gallery-thumb>
      </div>
    </div>
  `,
                    standalone: true,
                    imports: [CommonModule, GalleryThumbComponent]
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.NgZone }, { type: i1.SmoothScrollManager }, { type: i0.ChangeDetectorRef }, { type: i2.Platform }]; }, propDecorators: { state: [{
                type: Input
            }], config: [{
                type: Input
            }], thumbClick: [{
                type: Output
            }], error: [{
                type: Output
            }], sliderEl: [{
                type: ViewChild,
                args: ['slider', { static: true }]
            }], items: [{
                type: ViewChildren,
                args: [GalleryThumbComponent, { read: ElementRef }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FsbGVyeS10aHVtYnMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctZ2FsbGVyeS9zcmMvbGliL2NvbXBvbmVudHMvZ2FsbGVyeS10aHVtYnMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFLTixTQUFTLEVBQ1QsWUFBWSxFQUNaLFNBQVMsRUFHVCxVQUFVLEVBQ1YsWUFBWSxFQUVaLHVCQUF1QixFQUN4QixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFL0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUc3RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDekUsT0FBTyxFQUFzQixzQkFBc0IsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUU5RixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM1RCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQzs7Ozs7QUFJbEUsTUF3QmEsc0JBQXNCO0lBOEJqQyxJQUFJLE1BQU07UUFDUixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDO0lBQ3JDLENBQUM7SUFFRCxZQUFvQixHQUFlLEVBQ2YsS0FBYSxFQUNiLGFBQWtDLEVBQ2xDLEdBQXNCLEVBQ3RCLFNBQW1CO1FBSm5CLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFDZixVQUFLLEdBQUwsS0FBSyxDQUFRO1FBQ2Isa0JBQWEsR0FBYixhQUFhLENBQXFCO1FBQ2xDLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQ3RCLGNBQVMsR0FBVCxTQUFT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QyxPQUFPLEVBQUUsT0FBTyxFQUFFLENBQUM7SUFDMUIsQ0FBQzs4R0F6TFUsc0JBQXNCO2tHQUF0QixzQkFBc0IsNFNBNEJuQixxQkFBcUIsMkJBQVUsVUFBVSxrREFqRDdDOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCVCwyREFFUyxZQUFZLDRKQUFFLHFCQUFxQjs7U0FFbEMsc0JBQXNCOzJGQUF0QixzQkFBc0I7a0JBeEJsQyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxnQkFBZ0I7b0JBQzFCLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO29CQUMvQyxRQUFRLEVBQUU7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJUO29CQUNELFVBQVUsRUFBRSxJQUFJO29CQUNoQixPQUFPLEVBQUUsQ0FBQyxZQUFZLEVBQUUscUJBQXFCLENBQUM7aUJBQy9DOytNQWVVLEtBQUs7c0JBQWIsS0FBSztnQkFHRyxNQUFNO3NCQUFkLEtBQUs7Z0JBR0ksVUFBVTtzQkFBbkIsTUFBTTtnQkFHRyxLQUFLO3NCQUFkLE1BQU07Z0JBR2dDLFFBQVE7c0JBQTlDLFNBQVM7dUJBQUMsUUFBUSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtnQkFFc0IsS0FBSztzQkFBL0QsWUFBWTt1QkFBQyxxQkFBcUIsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENvbXBvbmVudCxcclxuICBJbnB1dCxcclxuICBPdXRwdXQsXHJcbiAgQWZ0ZXJWaWV3SW5pdCxcclxuICBBZnRlclZpZXdDaGVja2VkLFxyXG4gIE9uRGVzdHJveSxcclxuICBPbkNoYW5nZXMsXHJcbiAgVmlld0NoaWxkLFxyXG4gIFZpZXdDaGlsZHJlbixcclxuICBRdWVyeUxpc3QsXHJcbiAgU2ltcGxlQ2hhbmdlcyxcclxuICBOZ1pvbmUsXHJcbiAgRWxlbWVudFJlZixcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3lcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29tbW9uTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdAYW5ndWxhci9jZGsvcGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBTdWJqZWN0LCBkZWJvdW5jZVRpbWUsIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEdhbGxlcnlDb25maWcgfSBmcm9tICcuLi9tb2RlbHMvY29uZmlnLm1vZGVsJztcclxuaW1wb3J0IHsgR2FsbGVyeVN0YXRlLCBHYWxsZXJ5RXJyb3IgfSBmcm9tICcuLi9tb2RlbHMvZ2FsbGVyeS5tb2RlbCc7XHJcbmltcG9ydCB7IFRodW1ibmFpbHNQb3NpdGlvbiwgVGh1bWJuYWlsc1ZpZXcgfSBmcm9tICcuLi9tb2RlbHMvY29uc3RhbnRzJztcclxuaW1wb3J0IHsgVGh1bWJTbGlkZXJBZGFwdGVyLCBIb3Jpem9udGFsVGh1bWJBZGFwdGVyLCBWZXJ0aWNhbFRodW1iQWRhcHRlciB9IGZyb20gJy4vYWRhcHRlcnMnO1xyXG5pbXBvcnQgeyBTbW9vdGhTY3JvbGxNYW5hZ2VyIH0gZnJvbSAnLi4vc21vb3RoLXNjcm9sbCc7XHJcbmltcG9ydCB7IHJlc2l6ZU9ic2VydmFibGUgfSBmcm9tICcuLi91dGlscy9yZXNpemUtb2JzZXJ2ZXInO1xyXG5pbXBvcnQgeyBHYWxsZXJ5VGh1bWJDb21wb25lbnQgfSBmcm9tICcuL2dhbGxlcnktdGh1bWIuY29tcG9uZW50JztcclxuXHJcbmRlY2xhcmUgY29uc3QgSGFtbWVyOiBhbnk7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ2dhbGxlcnktdGh1bWJzJyxcclxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcclxuICB0ZW1wbGF0ZTogYFxyXG4gICAgPGRpdiAjc2xpZGVyXHJcbiAgICAgICAgIGNsYXNzPVwiZy1zbGlkZXJcIlxyXG4gICAgICAgICBbYXR0ci5jZW50cmFsaXNlZF09XCJjb25maWcudGh1bWJWaWV3ID09PSB0aHVtYm5haWxzVmlldy5Db250YWluIHx8IGFkYXB0ZXIuaXNDb250ZW50TGVzc1RoYW5Db250YWluZXJcIj5cclxuICAgICAgPGRpdiBjbGFzcz1cImctc2xpZGVyLWNvbnRlbnRcIj5cclxuICAgICAgICA8Z2FsbGVyeS10aHVtYiAqbmdGb3I9XCJsZXQgaXRlbSBvZiBzdGF0ZS5pdGVtczsgdHJhY2tCeTogdHJhY2tCeUZuOyBpbmRleCBhcyBpXCJcclxuICAgICAgICAgICAgICAgICAgICAgICBbdHlwZV09XCJpdGVtLnR5cGVcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgIFtjb25maWddPVwiY29uZmlnXCJcclxuICAgICAgICAgICAgICAgICAgICAgICBbZGF0YV09XCJpdGVtLmRhdGFcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgIFtjdXJySW5kZXhdPVwic3RhdGUuY3VyckluZGV4XCJcclxuICAgICAgICAgICAgICAgICAgICAgICBbaW5kZXhdPVwiaVwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgW2NvdW50XT1cInN0YXRlLml0ZW1zLmxlbmd0aFwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgKGNsaWNrKT1cImNvbmZpZy5kaXNhYmxlVGh1bWIgPyBudWxsIDogdGh1bWJDbGljay5lbWl0KGkpXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAoZXJyb3IpPVwiZXJyb3IuZW1pdCh7IGl0ZW1JbmRleDogaSwgZXJyb3I6ICRldmVudCB9KVwiPlxyXG4gICAgICAgIDwvZ2FsbGVyeS10aHVtYj5cclxuICAgICAgPC9kaXY+XHJcbiAgICA8L2Rpdj5cclxuICBgLFxyXG4gIHN0YW5kYWxvbmU6IHRydWUsXHJcbiAgaW1wb3J0czogW0NvbW1vbk1vZHVsZSwgR2FsbGVyeVRodW1iQ29tcG9uZW50XVxyXG59KVxyXG5leHBvcnQgY2xhc3MgR2FsbGVyeVRodW1ic0NvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIEFmdGVyVmlld0NoZWNrZWQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcclxuXHJcbiAgLyoqIEhhbW1lckpTIGluc3RhbmNlICovXHJcbiAgcHJpdmF0ZSBfaGFtbWVyOiBhbnk7XHJcblxyXG4gIC8qKiBUaHVtYm5haWxzIHZpZXcgZW51bSAqL1xyXG4gIHJlYWRvbmx5IHRodW1ibmFpbHNWaWV3ID0gVGh1bWJuYWlsc1ZpZXc7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2Rlc3Ryb3llZCQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG5cclxuICAvKiogU2xpZGVyIGFkYXB0ZXIgKi9cclxuICBhZGFwdGVyOiBUaHVtYlNsaWRlckFkYXB0ZXI7XHJcblxyXG4gIC8qKiBHYWxsZXJ5IHN0YXRlICovXHJcbiAgQElucHV0KCkgc3RhdGU6IEdhbGxlcnlTdGF0ZTtcclxuXHJcbiAgLyoqIEdhbGxlcnkgY29uZmlnICovXHJcbiAgQElucHV0KCkgY29uZmlnOiBHYWxsZXJ5Q29uZmlnO1xyXG5cclxuICAvKiogU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiB0aHVtYiBpcyBjbGlja2VkICovXHJcbiAgQE91dHB1dCgpIHRodW1iQ2xpY2sgPSBuZXcgRXZlbnRFbWl0dGVyPG51bWJlcj4oKTtcclxuXHJcbiAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gYW4gZXJyb3Igb2NjdXJzICovXHJcbiAgQE91dHB1dCgpIGVycm9yID0gbmV3IEV2ZW50RW1pdHRlcjxHYWxsZXJ5RXJyb3I+KCk7XHJcblxyXG4gIC8qKiBTbGlkZXIgRWxlbWVudFJlZiAqL1xyXG4gIEBWaWV3Q2hpbGQoJ3NsaWRlcicsIHsgc3RhdGljOiB0cnVlIH0pIHNsaWRlckVsOiBFbGVtZW50UmVmO1xyXG5cclxuICBAVmlld0NoaWxkcmVuKEdhbGxlcnlUaHVtYkNvbXBvbmVudCwgeyByZWFkOiBFbGVtZW50UmVmIH0pIGl0ZW1zID0gbmV3IFF1ZXJ5TGlzdDxFbGVtZW50UmVmPEhUTUxFbGVtZW50Pj4oKTtcclxuXHJcbiAgZ2V0IHNsaWRlcigpOiBIVE1MRWxlbWVudCB7XHJcbiAgICByZXR1cm4gdGhpcy5zbGlkZXJFbC5uYXRpdmVFbGVtZW50O1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZWw6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfem9uZTogTmdab25lLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgX3Ntb290aFNjcm9sbDogU21vb3RoU2Nyb2xsTWFuYWdlcixcclxuICAgICAgICAgICAgICBwcml2YXRlIF9jZDogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfcGxhdGZvcm06IFBsYXRmb3JtKSB7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICBpZiAoY2hhbmdlcy5jb25maWcpIHtcclxuICAgICAgLy8gU2V0cyBzbGlkaW5nIGRpcmVjdGlvblxyXG4gICAgICBpZiAoY2hhbmdlcy5jb25maWcuY3VycmVudFZhbHVlPy50aHVtYlBvc2l0aW9uICE9PSBjaGFuZ2VzLmNvbmZpZy5wcmV2aW91c1ZhbHVlPy50aHVtYlBvc2l0aW9uKSB7XHJcbiAgICAgICAgc3dpdGNoICh0aGlzLmNvbmZpZy50aHVtYlBvc2l0aW9uKSB7XHJcbiAgICAgICAgICBjYXNlIFRodW1ibmFpbHNQb3NpdGlvbi5SaWdodDpcclxuICAgICAgICAgIGNhc2UgVGh1bWJuYWlsc1Bvc2l0aW9uLkxlZnQ6XHJcbiAgICAgICAgICAgIHRoaXMuYWRhcHRlciA9IG5ldyBWZXJ0aWNhbFRodW1iQWRhcHRlcih0aGlzLnNsaWRlciwgdGhpcy5jb25maWcpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGNhc2UgVGh1bWJuYWlsc1Bvc2l0aW9uLlRvcDpcclxuICAgICAgICAgIGNhc2UgVGh1bWJuYWlsc1Bvc2l0aW9uLkJvdHRvbTpcclxuICAgICAgICAgICAgdGhpcy5hZGFwdGVyID0gbmV3IEhvcml6b250YWxUaHVtYkFkYXB0ZXIodGhpcy5zbGlkZXIsIHRoaXMuY29uZmlnKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5fcGxhdGZvcm0uaXNCcm93c2VyKSB7XHJcbiAgICAgICAgICBpZiAoIWNoYW5nZXMuY29uZmlnLmZpcnN0Q2hhbmdlKSB7XHJcbiAgICAgICAgICAgIC8vIEtlZXAgdGhlIGNvcnJlY3Qgc2xpZGluZyBwb3NpdGlvbiB3aGVuIGRpcmVjdGlvbiBjaGFuZ2VzXHJcbiAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgdGhpcy5zY3JvbGxUb0luZGV4KHRoaXMuc3RhdGUuY3VyckluZGV4LCAnYXV0bycpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAvLyBSZWFjdGl2YXRlIGdlc3R1cmVzXHJcbiAgICAgICAgICB0aGlzLmVuYWJsZURpc2FibGVHZXN0dXJlcygpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5fcGxhdGZvcm0uaXNCcm93c2VyKSB7XHJcbiAgICAgICAgaWYgKCFjaGFuZ2VzLmNvbmZpZy5maXJzdENoYW5nZSAmJiBjaGFuZ2VzLmNvbmZpZy5jdXJyZW50VmFsdWU/LnRodW1iTW91c2VTbGlkaW5nRGlzYWJsZWQgIT09IGNoYW5nZXMuY29uZmlnLnByZXZpb3VzVmFsdWU/LnRodW1iTW91c2VTbGlkaW5nRGlzYWJsZWQpIHtcclxuICAgICAgICAgIHRoaXMuZW5hYmxlRGlzYWJsZUdlc3R1cmVzKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnNsaWRlci5zdHlsZS5zZXRQcm9wZXJ0eSgnLS10aHVtYi1oZWlnaHQnLCBgJHsgdGhpcy5jb25maWcudGh1bWJIZWlnaHQgfXB4YCk7XHJcbiAgICAgICAgdGhpcy5zbGlkZXIuc3R5bGUuc2V0UHJvcGVydHkoJy0tdGh1bWItd2lkdGgnLCBgJHsgdGhpcy5jb25maWcudGh1bWJXaWR0aCB9cHhgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9wbGF0Zm9ybS5pc0Jyb3dzZXIgJiYgY2hhbmdlcy5zdGF0ZSAmJiAoY2hhbmdlcy5zdGF0ZS5maXJzdENoYW5nZSB8fCAhdGhpcy5jb25maWcudGh1bWJEZXRhY2hlZCkpIHtcclxuICAgICAgaWYgKGNoYW5nZXMuc3RhdGUuY3VycmVudFZhbHVlPy5jdXJySW5kZXggIT09IGNoYW5nZXMuc3RhdGUucHJldmlvdXNWYWx1ZT8uY3VyckluZGV4KSB7XHJcbiAgICAgICAgLy8gU2Nyb2xsIHNsaWRlIHRvIGl0ZW0gd2hlbiBjdXJyZW50IGluZGV4IGNoYW5nZXMuXHJcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuc2Nyb2xsVG9JbmRleCh0aGlzLnN0YXRlLmN1cnJJbmRleCwgY2hhbmdlcy5zdGF0ZT8uZmlyc3RDaGFuZ2UgPyAnYXV0bycgOiAnc21vb3RoJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLl9wbGF0Zm9ybS5pc0Jyb3dzZXIpIHtcclxuICAgICAgLy8gV29ya2Fyb3VuZDogb3BlbmluZyBhIGxpZ2h0Ym94IChjZW50cmFsaXNlZCkgd2l0aCBsYXN0IGluZGV4IGFjdGl2ZSwgc2hvdyBpbiB3cm9uZyBwb3NpdGlvblxyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuc2Nyb2xsVG9JbmRleCh0aGlzLnN0YXRlLmN1cnJJbmRleCwgJ2F1dG8nKSwgMjAwKTtcclxuXHJcbiAgICAgIHRoaXMuX3pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgIC8vIFVwZGF0ZSBuZWNlc3NhcnkgY2FsY3VsYXRpb24gb24gaG9zdCByZXNpemVcclxuICAgICAgICByZXNpemVPYnNlcnZhYmxlKHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQpLnBpcGUoXHJcbiAgICAgICAgICBkZWJvdW5jZVRpbWUodGhpcy5jb25maWcucmVzaXplRGVib3VuY2VUaW1lKSxcclxuICAgICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aHVtYiBjZW50cmFsaXplIHNpemVcclxuICAgICAgICAgICAgY29uc3QgZWw6IEhUTUxFbGVtZW50ID0gdGhpcy5pdGVtcy5nZXQodGhpcy5zdGF0ZS5jdXJySW5kZXgpPy5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgICAgICBpZiAoZWwpIHtcclxuICAgICAgICAgICAgICB0aGlzLnNsaWRlci5zdHlsZS5zZXRQcm9wZXJ0eSgnLS10aHVtYi1jZW50cmFsaXplLXN0YXJ0LXNpemUnLCB0aGlzLmFkYXB0ZXIuZ2V0Q2VudHJhbGl6ZXJTdGFydFNpemUoKSArICdweCcpO1xyXG4gICAgICAgICAgICAgIHRoaXMuc2xpZGVyLnN0eWxlLnNldFByb3BlcnR5KCctLXRodW1iLWNlbnRyYWxpemUtZW5kLXNpemUnLCB0aGlzLmFkYXB0ZXIuZ2V0Q2VudHJhbGl6ZXJFbmRTaXplKCkgKyAncHgnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLl9jZC5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9JbmRleCh0aGlzLnN0YXRlLmN1cnJJbmRleCwgJ2F1dG8nKTtcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCQpXHJcbiAgICAgICAgKS5zdWJzY3JpYmUoKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0NoZWNrZWQoKTogdm9pZCB7XHJcbiAgICBjb25zdCBlbDogSFRNTEVsZW1lbnQgPSB0aGlzLml0ZW1zLmdldCh0aGlzLnN0YXRlLmN1cnJJbmRleCk/Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICBpZiAoZWwgJiYgdGhpcy5fcGxhdGZvcm0uaXNCcm93c2VyKSB7XHJcbiAgICAgIHRoaXMuc2xpZGVyLnN0eWxlLnNldFByb3BlcnR5KCctLXRodW1iLWNlbnRyYWxpemUtc3RhcnQtc2l6ZScsIHRoaXMuYWRhcHRlci5nZXRDZW50cmFsaXplclN0YXJ0U2l6ZSgpICsgJ3B4Jyk7XHJcbiAgICAgIHRoaXMuc2xpZGVyLnN0eWxlLnNldFByb3BlcnR5KCctLXRodW1iLWNlbnRyYWxpemUtZW5kLXNpemUnLCB0aGlzLmFkYXB0ZXIuZ2V0Q2VudHJhbGl6ZXJFbmRTaXplKCkgKyAncHgnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5kZWFjdGl2YXRlR2VzdHVyZXMoKTtcclxuICAgIHRoaXMuX2Rlc3Ryb3llZCQubmV4dCgpO1xyXG4gICAgdGhpcy5fZGVzdHJveWVkJC5jb21wbGV0ZSgpO1xyXG4gIH1cclxuXHJcbiAgdHJhY2tCeUZuKGluZGV4OiBudW1iZXIsIGl0ZW06IGFueSkge1xyXG4gICAgcmV0dXJuIGl0ZW0udHlwZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2Nyb2xsVG9JbmRleCh2YWx1ZTogbnVtYmVyLCBiZWhhdmlvcjogU2Nyb2xsQmVoYXZpb3IpOiB2b2lkIHtcclxuICAgIHRoaXMuX3pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICB0aGlzLnNsaWRlci5zdHlsZS5zY3JvbGxTbmFwVHlwZSA9ICd1bnNldCc7XHJcblxyXG4gICAgICBjb25zdCBlbDogSFRNTEVsZW1lbnQgPSB0aGlzLml0ZW1zLmdldCh2YWx1ZSk/Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgIGlmIChlbCkge1xyXG4gICAgICAgIHRoaXMuX3Ntb290aFNjcm9sbC5zY3JvbGxUbyh0aGlzLnNsaWRlciwgdGhpcy5hZGFwdGVyLmdldFNjcm9sbFRvVmFsdWUoZWwsIGJlaGF2aW9yKSkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnNsaWRlci5zdHlsZS5zY3JvbGxTbmFwVHlwZSA9IHRoaXMuYWRhcHRlci5zY3JvbGxTbmFwVHlwZTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGVuYWJsZURpc2FibGVHZXN0dXJlcygpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5fcGxhdGZvcm0uSU9TICYmICF0aGlzLl9wbGF0Zm9ybS5BTkRST0lEKSB7XHJcbiAgICAgIC8vIEVuYWJsZS9EaXNhYmxlIG1vdXNlIHNsaWRpbmcgb24gZGVza3RvcCBicm93c2VyIG9ubHlcclxuICAgICAgaWYgKCF0aGlzLmNvbmZpZy50aHVtYk1vdXNlU2xpZGluZ0Rpc2FibGVkKSB7XHJcbiAgICAgICAgdGhpcy5hY3RpdmF0ZUdlc3R1cmVzKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5kZWFjdGl2YXRlR2VzdHVyZXMoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhY3RpdmF0ZUdlc3R1cmVzKCk6IHZvaWQge1xyXG4gICAgaWYgKHR5cGVvZiBIYW1tZXIgIT09ICd1bmRlZmluZWQnICYmICF0aGlzLmNvbmZpZy5kaXNhYmxlVGh1bWIpIHtcclxuXHJcbiAgICAgIGNvbnN0IGRpcmVjdGlvbjogbnVtYmVyID0gdGhpcy5hZGFwdGVyLnBhbkRpcmVjdGlvbjtcclxuXHJcbiAgICAgIC8vIEFjdGl2YXRlIGdlc3R1cmVzXHJcbiAgICAgIHRoaXMuX3pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuX2hhbW1lciA9IG5ldyBIYW1tZXIodGhpcy5fZWwubmF0aXZlRWxlbWVudCwgeyBpbnB1dENsYXNzOiBIYW1tZXIuTW91c2VJbnB1dCB9KTtcclxuICAgICAgICB0aGlzLl9oYW1tZXIuZ2V0KCdwYW4nKS5zZXQoeyBkaXJlY3Rpb24gfSk7XHJcblxyXG4gICAgICAgIGxldCBwYW5PZmZzZXQ6IG51bWJlciA9IDA7XHJcblxyXG4gICAgICAgIHRoaXMuX2hhbW1lci5vbigncGFuc3RhcnQnLCAoKSA9PiB7XHJcbiAgICAgICAgICBwYW5PZmZzZXQgPSB0aGlzLmFkYXB0ZXIuc2Nyb2xsVmFsdWU7XHJcbiAgICAgICAgICAvLyBEaXNhYmxlIHNjcm9sbC1zbmFwLXR5cGUgZnVuY3Rpb25hbGl0eVxyXG4gICAgICAgICAgdGhpcy5zbGlkZXIuc3R5bGUuc2Nyb2xsU25hcFR5cGUgPSAndW5zZXQnO1xyXG4gICAgICAgICAgdGhpcy5zbGlkZXIuY2xhc3NMaXN0LmFkZCgnZy1zbGlkaW5nJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5faGFtbWVyLm9uKCdwYW5tb3ZlJywgKGUpID0+IHRoaXMuc2xpZGVyLnNjcm9sbFRvKHRoaXMuYWRhcHRlci5nZXRQYW5WYWx1ZShwYW5PZmZzZXQsIGUsICdhdXRvJykpKTtcclxuICAgICAgICB0aGlzLl9oYW1tZXIub24oJ3BhbmVuZCcsICgpID0+IHtcclxuICAgICAgICAgIC8vIEVuYWJsZSBzY3JvbGwtc25hcC10eXBlIGZ1bmN0aW9uYWxpdHlcclxuICAgICAgICAgIHRoaXMuc2xpZGVyLnN0eWxlLnNjcm9sbFNuYXBUeXBlID0gdGhpcy5hZGFwdGVyLnNjcm9sbFNuYXBUeXBlO1xyXG4gICAgICAgICAgdGhpcy5zbGlkZXIuY2xhc3NMaXN0LnJlbW92ZSgnZy1zbGlkaW5nJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkZWFjdGl2YXRlR2VzdHVyZXMoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9oYW1tZXI/LmRlc3Ryb3koKTtcclxuICB9XHJcbn1cclxuIl19